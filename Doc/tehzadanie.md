## Техническое задание:
### Настройка автоматической сборки/компиляции и публикация бинарных файлов ПО для коммутатора “Симфония”.

#### Цель задания:

- Подключить систему автоматической сборки ПО с помощью Gitlab CI/CD для всей системы на базе openWrt.
- Подключить систему автоматической сборки ПО с помощью Gitlab CI/CD для отдельных приложений, на базе скомпилированного образа OpenWrt. 

#### Результат:

В результате автоматической сборки создаются бинарные файлы:   
    - прошивка целиком - `openwrt-11.22.33-realtek-rtl838x-tfortis_psw-2g8f-squashfs-sysupgrade.bin`;    
    - установочные файлы *.ipk каждого отдельного приложения входящего в образ сборки. Все установочные файлы распределены по директориям: target и packages.

### Описание задания:

#### I. настройка автосборки СI/CD для компиляции образа OpenWRT    
1. ПО для проекта “Симфония” хранится на Gitlab:
   http://gitlab.forttel.ru/TFortis/FirmWare/tfortis-realtek в **2-ух** репозиториях:
   - **Репозиторий с системой OpenWrt**: http://gitlab.forttel.ru/TFortis/FirmWare/tfortis-realtek/tfortis_openwrt
   - **Репозиторий с приложениями**, которые должны включаться в сборку: http://gitlab.forttel.ru/TFortis/FirmWare/tfortis-realtek/openwrt_tfortis_packages.git
2. Автоматическая Сборка проекта стартует по Тригеру: новый коммит в ветке **DEV** или **MAIN** в OpenWrt репозитории. 
3. В Gitlab Runner запускается Docker-контейнер на базе Линукс образа Ubuntu/Debian/ или другой подходящий дистрибутив; 
4. Устанавливаются необходимые пакеты для кросс-компиляции:  
   make, openssh-server, checkinstall, autoconf, automake,build-essential, libncurses5-dev,
   zlib1g-dev, lib32z1, gawk, gcc-multilib, flex,  git, gettext, libssl-dev, python3-distutils, cmake, 
   rsync, unzip, file, wget, device-tree-compiler, vim
5. Клонируются исходники OpenWRT из репозитория http://gitlab.forttel.ru/TFortis/FirmWare/tfortis-realtek/tfortis_openwrt; 
6. Переход в директорию  `cd openWrt`;
7. Смена актуальной версии OpenWrt `git checkout openwrt-XX.XX`
8. Обновление и установка дополнительных приложений/пакетов из второго репозитория  
(путь к репозиторию указывается в файле: /openWrt_home/feeds.conf.default) выполняется командами:  
``./scripts/feeds update -a``        
``./scripts/feeds install -a``     
9. Удалить артефакты от предыдущих сборок      
``make clean``
10. Запустить компиляцию:  
`make V=-1 jN`, N - количество ядер процессора (может определяться автоматически).
11. При успешной компиляции бинарный файл  
`openWrt_home/bin/targets/realtek/rtl838x/openwrt-11.22.33-realtek-rtl838x-tfortis_psw-2g8f-squashfs-sysupgrade.bin`  
помещается в Release с версией прошивки (возможны различные варианты)
12. Из изменённого дитрибутива Линукс вместе с скомпилированной версии OpenWrt создаётся Docker-образ и помещается в хранилище Docker-образов.  
Имя созданного Докер-образа должно содержать номер версии. 

#### II. Настройка автосборки СI/CD для компиляции отдельных приложений
1. Сборка приложений стартует по Тригеру: новый коммит в ветке **DEV** или **MAIN** в репозитории с приложениями;
2. Скачивается из хранилища и разворачивается Docker-образ, созданный на предыдущем этапе, с нужной версией;
3. Должна быть возможность просто указывать номер версии Докер-образа, который необходимо развернуть;
4. Обновление и установка дополнительных приложений/пакетов из второго репозитория выполняется командами:  
   ``./scripts/feeds update -a``        
   ``./scripts/feeds install -a``
5. Удалить артефакты от предыдущих сборок      
   ``make clean``
6. Запустить компиляцию:  
    `make V=-1 jN`, N - количество ядер процессора (может определяться автоматически); 
7. При успешной компиляции бинарный файл  
    `openWrt_home/bin/targets/realtek/rtl838x/openwrt-11.22.33-realtek-rtl838x-tfortis_psw-2g8f-squashfs-sysupgrade.bin`  
    помещается в Release с версией прошивки (возможны различные варианты);
8. Файлы *.ipk из директории `/openwrt_home/bin/packages/mips_4kec/openwrt_tfortis_packages` помещаются в релиз и доступны для скачивания; 

### Замечания:
** Возможны варианты для публикации бинарных файлов:
- Вместо публикации отдельных бинарных файлов и файлов приложений *.ipk,     
публиковать архив с бинарными файлами, т.е всю директорию `/openwrt_home/bin/` помещать в архив или разделять на 2-а архива: 
  - `/openwrt_home/bin/packages`
  - `openWrt_home/bin/targets/`
- Бинарные файлы отправлять в отдельный репозиторий, т.е создавать Commit и Push с возможностью добавлять комментарий и номер версии к Коммиту.

** Номера версий готовых релизов должны автоматически нумероваться из текста коммита или из Make-файлов







 
